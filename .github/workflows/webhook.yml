name: Discord Changelog Webhook

on:
  push:
    branches:
      - main

jobs:
  discord_webhook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Send Discord Webhook
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          # Dados do commit
          COMMIT_HASH=$(git rev-parse --short HEAD)
          FULL_MESSAGE=$(git log -1 --pretty=%B | tr -d '\r')
          TITLE=$(echo "$FULL_MESSAGE" | head -n1)               # primeira linha como t√≠tulo
          DESCRIPTION=$(echo "$FULL_MESSAGE" | tail -n +2)       # resto como descri√ß√£o
          DESCRIPTION=${DESCRIPTION:-"Sem descri√ß√£o"}            # se n√£o houver descri√ß√£o
          AUTHOR_NAME=$(git log -1 --pretty=format:%an)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          COMMIT_URL="https://github.com/${GITHUB_REPOSITORY}/commit/${COMMIT_HASH}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # JSON do embed
          JSON=$(jq -n \
            --arg title "üìù $TITLE (\`$COMMIT_HASH\`)" \
            --arg url "$COMMIT_URL" \
            --arg description "$DESCRIPTION" \
            --arg author "$AUTHOR_NAME" \
            --arg branch "$BRANCH_NAME" \
            --arg timestamp "$TIMESTAMP" \
            '{
              username: "Chaos Changelog",
              avatar_url: "https://cdn-icons-png.flaticon.com/512/733/733553.png",
              embeds: [
                {
                  title: $title,
                  url: $url,
                  color: 3447003,
                  fields: [
                    {
                      name: "üìÑ Descri√ß√£o",
                      value: $description,
                      inline: false
                    },
                    {
                      name: "üë§ Autor",
                      value: $author,
                      inline: true
                    },
                    {
                      name: "üåø Branch",
                      value: $branch,
                      inline: true
                    }
                  ],
                  footer: {
                    text: "ChaosHub ‚Ä¢ GitHub Changelog",
                    icon_url: "https://cdn-icons-png.flaticon.com/512/733/733553.png"
                  },
                  timestamp: $timestamp
                }
              ]
            }')

          # Envia pro Discord
          curl -H "Content-Type: application/json" -d "$JSON" $DISCORD_WEBHOOK_URL